{"version":3,"sources":["../../../../src/start/server/getStaticRenderFunctions.ts"],"sourcesContent":["/**\n * Copyright Â© 2022 650 Industries.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n */\nimport fs from 'fs';\nimport fetch from 'node-fetch';\nimport path from 'path';\nimport requireString from 'require-from-string';\nimport resolveFrom from 'resolve-from';\n\nimport { logMetroError } from './metro/metroErrorInterface';\nimport { getMetroServerRoot } from './middleware/ManifestMiddleware';\nimport { stripAnsi } from '../../utils/ansi';\nimport { delayAsync } from '../../utils/delay';\nimport { SilentError } from '../../utils/errors';\nimport { memoize } from '../../utils/fn';\nimport { profile } from '../../utils/profile';\n\nconst debug = require('debug')('expo:start:server:node-renderer') as typeof console.log;\n\nfunction wrapBundle(str: string) {\n  // Skip the metro runtime so debugging is a bit easier.\n  // Replace the __r() call with an export statement.\n  // Use gm to apply to the last require line. This is needed when the bundle has side-effects.\n  return str.replace(/^(__r\\(.*\\);)$/gm, 'module.exports = $1');\n}\n\n// TODO(EvanBacon): Group all the code together and version.\nconst getRenderModuleId = (projectRoot: string): string => {\n  const moduleId = resolveFrom.silent(projectRoot, 'expo-router/node/render.js');\n  if (!moduleId) {\n    throw new Error(\n      `A version of expo-router with Node.js support is not installed in the project.`\n    );\n  }\n\n  return moduleId;\n};\n\ntype StaticRenderOptions = {\n  // Ensure the style format is `css-xxxx` (prod) instead of `css-view-xxxx` (dev)\n  dev?: boolean;\n  minify?: boolean;\n  platform?: string;\n  environment?: 'node';\n  engine?: 'hermes';\n};\n\nconst moveStaticRenderFunction = memoize(async (projectRoot: string, requiredModuleId: string) => {\n  // Copy the file into the project to ensure it works in monorepos.\n  // This means the file cannot have any relative imports.\n  const tempDir = path.join(projectRoot, '.expo/static');\n  await fs.promises.mkdir(tempDir, { recursive: true });\n  const moduleId = path.join(tempDir, 'render.js');\n  await fs.promises.writeFile(moduleId, await fs.promises.readFile(requiredModuleId, 'utf8'));\n  // Sleep to give watchman time to register the file.\n  await delayAsync(50);\n  return moduleId;\n});\n\n/** @returns the js file contents required to generate the static generation function. */\nexport async function getStaticRenderFunctionsContentAsync(\n  projectRoot: string,\n  devServerUrl: string,\n  { dev = false, minify = false, environment }: StaticRenderOptions = {}\n): Promise<string> {\n  const root = getMetroServerRoot(projectRoot);\n  const requiredModuleId = getRenderModuleId(root);\n  let moduleId = requiredModuleId;\n\n  // Cannot be accessed using Metro's server API, we need to move the file\n  // into the project root and try again.\n  if (path.relative(root, moduleId).startsWith('..')) {\n    moduleId = await moveStaticRenderFunction(projectRoot, requiredModuleId);\n  }\n\n  return requireFileContentsWithMetro(root, devServerUrl, moduleId, { dev, minify, environment });\n}\n\nasync function ensureFileInRootDirectory(projectRoot: string, otherFile: string) {\n  // Cannot be accessed using Metro's server API, we need to move the file\n  // into the project root and try again.\n  if (!path.relative(projectRoot, otherFile).startsWith('../')) {\n    return otherFile;\n  }\n\n  // Copy the file into the project to ensure it works in monorepos.\n  // This means the file cannot have any relative imports.\n  const tempDir = path.join(projectRoot, '.expo/static-tmp');\n  await fs.promises.mkdir(tempDir, { recursive: true });\n  const moduleId = path.join(tempDir, path.basename(otherFile));\n  await fs.promises.writeFile(moduleId, await fs.promises.readFile(otherFile, 'utf8'));\n  // Sleep to give watchman time to register the file.\n  await delayAsync(50);\n  return moduleId;\n}\n\nexport async function createMetroEndpointAsync(\n  projectRoot: string,\n  devServerUrl: string,\n  absoluteFilePath: string,\n  {\n    dev = false,\n    platform = 'web',\n    minify = false,\n    environment,\n    engine = 'hermes',\n  }: StaticRenderOptions = {}\n): Promise<string> {\n  const root = getMetroServerRoot(projectRoot);\n  const safeOtherFile = await ensureFileInRootDirectory(projectRoot, absoluteFilePath);\n  const serverPath = path.relative(root, safeOtherFile).replace(/\\.[jt]sx?$/, '.bundle');\n  debug('fetching from Metro:', root, serverPath);\n\n  let url = `${devServerUrl}/${serverPath}?platform=${platform}&dev=${dev}&minify=${minify}`;\n\n  if (environment) {\n    url += `&resolver.environment=${environment}&transform.environment=${environment}`;\n  }\n  if (engine) {\n    url += `&transform.engine=${engine}`;\n  }\n  return url;\n}\n\nexport class MetroNodeError extends Error {\n  constructor(\n    message: string,\n    public rawObject: any\n  ) {\n    super(message);\n  }\n}\n\nexport async function requireFileContentsWithMetro(\n  projectRoot: string,\n  devServerUrl: string,\n  absoluteFilePath: string,\n  props: StaticRenderOptions = {}\n): Promise<string> {\n  const url = await createMetroEndpointAsync(projectRoot, devServerUrl, absoluteFilePath, props);\n\n  const res = await fetch(url);\n\n  // TODO: Improve error handling\n  if (res.status === 500) {\n    const text = await res.text();\n    if (text.startsWith('{\"originModulePath\"') || text.startsWith('{\"type\":\"TransformError\"')) {\n      const errorObject = JSON.parse(text);\n\n      throw new MetroNodeError(stripAnsi(errorObject.message) ?? errorObject.message, errorObject);\n    }\n    throw new Error(`[${res.status}]: ${res.statusText}\\n${text}`);\n  }\n\n  if (!res.ok) {\n    throw new Error(`Error fetching bundle for static rendering: ${res.status} ${res.statusText}`);\n  }\n\n  const content = await res.text();\n\n  return wrapBundle(content);\n}\n\nexport async function requireWithMetro<T extends Record<string, (...args: any[]) => Promise<any>>>(\n  projectRoot: string,\n  devServerUrl: string,\n  absoluteFilePath: string,\n  options: StaticRenderOptions = {}\n): Promise<T> {\n  const content = await requireFileContentsWithMetro(\n    projectRoot,\n    devServerUrl,\n    absoluteFilePath,\n    options\n  );\n  return evalMetroAndWrapFunctions<T>(projectRoot, content);\n}\n\nexport async function getStaticRenderFunctions(\n  projectRoot: string,\n  devServerUrl: string,\n  options: StaticRenderOptions = {}\n): Promise<Record<string, (...args: any[]) => Promise<any>>> {\n  const scriptContents = await getStaticRenderFunctionsContentAsync(\n    projectRoot,\n    devServerUrl,\n    options\n  );\n\n  return evalMetroAndWrapFunctions(projectRoot, scriptContents);\n}\n\nexport function evalMetroAndWrapFunctions<T = Record<string, (...args: any[]) => Promise<any>>>(\n  projectRoot: string,\n  script: string\n): Promise<T> {\n  const contents = evalMetro(script);\n\n  // wrap each function with a try/catch that uses Metro's error formatter\n  return Object.keys(contents).reduce((acc, key) => {\n    const fn = contents[key];\n    if (typeof fn !== 'function') {\n      return { ...acc, [key]: fn };\n    }\n\n    acc[key] = async function (...props: any[]) {\n      try {\n        return await fn.apply(this, props);\n      } catch (error: any) {\n        await logMetroError(projectRoot, { error });\n        throw new SilentError(error);\n      }\n    };\n    return acc;\n  }, {} as any);\n}\n\nfunction evalMetro(src: string) {\n  return profile(requireString, 'eval-metro-bundle')(src);\n}\n"],"names":["getStaticRenderFunctionsContentAsync","createMetroEndpointAsync","requireFileContentsWithMetro","requireWithMetro","getStaticRenderFunctions","evalMetroAndWrapFunctions","debug","require","wrapBundle","str","replace","getRenderModuleId","projectRoot","moduleId","resolveFrom","silent","Error","moveStaticRenderFunction","memoize","requiredModuleId","tempDir","path","join","fs","promises","mkdir","recursive","writeFile","readFile","delayAsync","devServerUrl","dev","minify","environment","root","getMetroServerRoot","relative","startsWith","ensureFileInRootDirectory","otherFile","basename","absoluteFilePath","platform","engine","safeOtherFile","serverPath","url","MetroNodeError","constructor","message","rawObject","props","res","fetch","status","text","errorObject","JSON","parse","stripAnsi","statusText","ok","content","options","scriptContents","script","contents","evalMetro","Object","keys","reduce","acc","key","fn","apply","error","logMetroError","SilentError","src","profile","requireString"],"mappings":"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"}